@page "/login"
@rendermode InteractiveServer

@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@using PrzetrwajPL;

<div class="container">
	<div class="inContainer">
	<h2 style="text-align:center; font-weight:bold;">Zaloguj się</h2>
	<p style="text-align:center;">Witamy! Podaj swoje dane poniżej żeby się zalogować</p>
	<EditForm Model="@loginRequest" OnValidSubmit="HandleLogin" FormName="loginForm">
		<DataAnnotationsValidator />
		@if (!string.IsNullOrEmpty(errorMessage))
		{
			<div class="alert alert-danger pre-wrap" role="alert" style="color: black; text-align:center;">@errorMessage</div>
		}
		<label for="email">E-mail:</label><br />
		<InputText @bind-Value="loginRequest.Email" id="email" placeholder="Podaj email" class="form-control"/>
		<ValidationMessage For="@(() => loginRequest.Email)" style="color:red; font-size: 12px;" /><br />

			<label for="password">Hasło:</label><br />
		<InputText @bind-Value="loginRequest.Password" type="password" id="password" placeholder="Podaj hasło" class="form-control"/>
		<ValidationMessage For="@(() => loginRequest.Password)" style="color:red; font-size: 12px;" /><br />

		<label>
			<input type="checkbox" checked="checked" name="remember"> Zapamiętaj mnie
		</label><br /><br />

		<button type="submit" disabled="@isLoading">
			@if (isLoading)
			{
				<span>Logowanie...</span>
			}
			else
			{
				<span>Zaloguj się</span>
			}
		</button><br /><br />

		<p>Nie masz konta? <a href="/register">Zarejestruj się</a></p>
		@* <p style="font-size:12px; text-align:center; margin-top: -10px"><a href=#>Prześlij ponownie potwierdzenie e-mail</a></p> *@
	</EditForm>
	</div>
	<div class="inContainer">
		<h2 style="text-align:center; font-weight:bold;">Szybkie logowanie</h2>
		<p>Użyj konta do zalogowania:</p><br />
		<button type="button" class="google">Google</button><br /><br />
		<button type="button" class="facebook">Facebook</button><br /><br />
		<button type="button" class="github">GitHub</button><br /><br />
		<button type="button" class="microsoft">Microsoft</button><br /><br />
	</div>
</div>

@code {
	private User? user = null;
	[SupplyParameterFromForm]
	public LoginRequest loginRequest { get; set; } = new LoginRequest();
	private string errorMessage = string.Empty;
	private bool isLoading = false;

	private async Task HandleLogin()
	{
		isLoading = true;
		errorMessage = string.Empty;
		try
		{
			var response = await HttpClient.PostAsJsonAsync("/Login/email", loginRequest);
			var result = await response.Content.ReadFromJsonAsync<User>();
			if (response.IsSuccessStatusCode)
			{
				if (result != null)
				{
					user = result;
					if (result.banned)
					{
						errorMessage = $"Twoje konto jest zablokowane. Powód: {result.banReason}";
					}
					else
					{
						NavigationManager.NavigateTo("/", forceLoad: true);
					}
				}
				else{
					errorMessage = "Nieprawidłowa odpowiedź z serwera.";
				}
			}
			else if (response.StatusCode == System.Net.HttpStatusCode.BadRequest && result?.banned == true)
			{
				errorMessage = $"Twoje konto jest zablokowane. Powód: {result.banReason}";
			}
			else
			{
				var errorText = await response.Content.ReadAsStringAsync();
				errorMessage = "Nieprawidłowy email lub hasło.";
			}
		}
		catch (Exception ex)
		{
			errorMessage = $"Błąd połączenia: {ex.Message}";
		}
		finally
		{
			isLoading = false;
		}
	}
}
